{% extends 'accounts/base.html' %}

{% block title %}Главная{% endblock %}
{% block header %}Калькулятор Ба Цзы{% endblock %}

{% block content %}
{% if user.is_authenticated %}

    <p>Сегодня: <strong>{{ current_date }}</strong></p>

    <!-- Форма для даты -->
    <div class="form-section">
        <h3>Введите дату рождения</h3>
        <input type="date" id="birthdayInput" required>
        <button id="submitBirthday">Отправить дату</button>
        <div id="birthdayResult"></div>
    </div>
    
    <!-- Форма для города (блокируется пока не отправлена дата) -->
    <div class="form-section">
        <h3>Введите город</h3>
        <input type="text" id="cityInput" disabled required>
        <button id="submitCity" disabled>Отправить город</button>
        <div id="cityResult"></div>
        <label>
            <input type="checkbox" id="changeTime"> Нужен расчёт по административному времени
        </label>
        <div id="checkTime"></div>
    </div>
    
<!-- 
    <div class="form-section">
        <h3>Введите интересующую дату</h3>
        <input type="date" id="ourdateInput" disabled required>
        <button id="submitOurdate">Отправить дату</button>
        <div id="ourdateResult"></div>
    </div> -->

    <script>
    // Обработка даты
    document.getElementById('submitBirthday').addEventListener('click', async () => {
        const birthday = document.getElementById('birthdayInput').value;
        
        const response = await fetch("{% url 'process_birthday' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ birthday })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('birthdayResult').innerHTML = `<p>${data.birthday_table}</p>`;
         
            // Активируем форму города
            document.getElementById('cityInput').disabled = false;
            document.getElementById('submitCity').disabled = false;
            
            // Сохраняем данные для последующих вычислений
            window.complexData = data.birthday_result;
        } else {
            alert('Ошибка: ' + data.error);
        }
    });

    // Обработка города
    document.getElementById('submitCity').addEventListener('click', async () => {
        const city = document.getElementById('cityInput').value;
        
        // Добавляем данные из предыдущего запроса
        const postData = { 
            city,
            ...window.complexData  // Распаковываем сохранённые данные
        };
        
        const response = await fetch("{% url 'process_city' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(postData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('cityResult').innerHTML = `
                <p>
                    <span class="rainbow-text">Текущее административное время:</span> 
                    <span style= "color: #4a7b9d; font-size: 16px; font-weight: bold;">${data.admin_time}</span>
                </p>               
                <p>
                    <span class="rainbow-text">Текущее солнечное время:</span> 
                    <span style= "color: #4a7b9d; font-size: 16px; font-weight: bold;">${data.solar_time}</span>
                </p>
                <p style="font-size: 12px">Рассчет по умолчанию выполняется по солнечному времени.
                    <br>Если нужен рассчет по времени административному, поставьте галочкуниже:</p>
            `;
            
            
            // Инициализируем переменную времени
            current_time = data.solar_time;
            
            // Обработчик изменения чекбокса
            document.getElementById('changeTime').addEventListener('change', function() {
                current_time = this.checked ? data.admin_time : data.solar_time;
                console.log('Текущее время:', current_time); // Для отладки
                document.getElementById('checkTime').innerHTML = `<div>Рассчетное время ${current_time}</div>`;
            });
            
        }
    })
    </script>


<style>
.invalid-feedback {
    color: #dc3545;
    font-size: 0.875em;
}
.is-invalid {
    border-color: #dc3545 !important;
}
</style>

    {% else %}
    <div style="text-align: center; margin: 30px 0;">
        <p>Для доступа к системе требуется авторизация</p>
        <div style="margin-top: 20px;">
            <a href="{% url 'login' %}" style="display: inline-block; margin: 0 10px;">
                <button>Войти</button>
            </a>
            <a href="{% url 'register' %}" style="display: inline-block; margin: 0 10px;">
                <button>Регистрация</button>
            </a>
        </div>
    </div>
{% endif %}

{% endblock %}